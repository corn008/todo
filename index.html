<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™å®ˆã€å¾Œç®¡è¡Œç¨‹ç®¡åˆ¶ç³»çµ±</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 4px;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 18px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 700;
        }

        .form-section {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 6px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 6px;
        }

        .form-row label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }

        .form-row input,
        .form-row select {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            min-height: 44px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-row input:focus,
        .form-row select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 1px 0;
            width: 100%;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            background: linear-gradient(135deg, #4f62c6 0%, #5f3780 100%);
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .btn-small {
            font-size: 14px;
            padding: 6px 10px;
            min-height: 36px;
            width: auto;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #ff5252 0%, #e53935 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .schedule-display {
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 8px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.9));
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .date-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #2c3e50;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .department {
            margin-bottom: 15px;
        }

        .department-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }

        .staff-list {
            margin-left: 12px;
        }

                 .staff-item {
             margin-bottom: 6px;
             padding: 12px;
             background: linear-gradient(145deg, #ffffff, #f8f9fa);
             border-radius: 8px;
             font-size: 15px;
             border: 1px solid rgba(102, 126, 234, 0.1);
             box-shadow: 0 2px 8px rgba(0,0,0,0.05);
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             justify-content: space-between;
         }

         .staff-item:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(0,0,0,0.1);
         }

         .staff-item .staff-info {
             display: flex;
             align-items: center;
             flex: 1;
         }

         .btn-delete {
             background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
             color: white;
             border: none;
             border-radius: 50%;
             width: 24px;
             height: 24px;
             font-size: 16px;
             font-weight: bold;
             cursor: pointer;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-left: 8px;
             transition: all 0.3s ease;
             box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
             -webkit-tap-highlight-color: transparent;
         }

         .btn-delete:hover {
             background: linear-gradient(135deg, #ff5252 0%, #e53935 100%);
             transform: scale(1.1);
             box-shadow: 0 4px 8px rgba(255, 107, 107, 0.4);
         }

         .btn-delete:active {
             transform: scale(0.95);
         }

        .staff-name {
            font-weight: bold;
            margin-right: 8px;
            color: #2c3e50;
        }

        .staff-status {
            color: #667eea;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }

        .no-data {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
            font-size: 16px;
        }

                 .view-controls {
             display: flex;
             flex-direction: column;
             gap: 6px;
             align-items: center;
             margin-bottom: 8px;
             position: relative;
             z-index: 10;
         }

                 .date-picker {
             display: inline-block;
             background: linear-gradient(145deg, #ffffff, #f8f9fa);
             border: 2px solid #e1e8ed;
             border-radius: 8px;
             padding: 8px;
             cursor: pointer;
             user-select: none;
             min-width: 100px;
             text-align: center;
             position: relative;
             transition: all 0.3s ease;
             box-shadow: 0 2px 8px rgba(0,0,0,0.05);
             z-index: 5;
         }

        .date-picker:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .date-picker.selected {
            border-color: #667eea;
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .date-picker .date-text {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .date-picker .date-hint {
            font-size: 13px;
            color: #666;
            margin-top: 2px;
        }

                 .calendar-popup {
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(20px);
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 16px;
             box-shadow: 0 20px 60px rgba(0,0,0,0.2);
             z-index: 2000;
             min-width: 300px;
             padding: 16px;
             max-width: 95vw;
             max-height: 85vh;
             overflow-y: auto;
         }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            color: #007bff;
            border-radius: 3px;
            min-width: 44px;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
        }

        .calendar-nav:hover {
            background: #f0f0f0;
        }

        .calendar-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 6px 2px;
            font-size: 14px;
        }

        .calendar-day {
            text-align: center;
            padding: 10px 2px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            margin: 1px;
        }

        .calendar-day:hover {
            background: linear-gradient(145deg, #f0f0f0, #e8e8e8);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .calendar-day.range-start {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #667eea;
            border: 2px solid #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .calendar-day.range-end {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #667eea;
            border: 2px solid #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .calendar-day.in-range {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #667eea;
        }

        .calendar-day.multi-selected {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .calendar-day.today {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #667eea;
            font-weight: bold;
            border: 2px solid #667eea;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.disabled:hover {
            background: none;
        }

        .selection-section {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 6px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .selection-section h3 {
            margin: 0 0 4px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }

        .calendar-footer {
            margin-top: 12px;
            text-align: center;
        }

        .calendar-footer .btn {
            margin: 0 3px;
            padding: 6px 12px;
            min-height: 32px;
        }

        .instructions {
            margin-top: 4px;
            font-size: 12px;
            color: #666;
        }

        .instructions div {
            margin-bottom: 2px;
        }

        .clear-btn {
            margin-top: 3px;
        }

        /* æ‰‹æ©Ÿè§¸æ§å„ªåŒ– */
        .btn {
            min-height: 44px;
        }
        
        .form-row input,
        .form-row select {
            min-height: 44px;
        }
        
        .calendar-day {
            min-height: 44px;
            font-size: 14px;
        }
        
                 /* é˜²æ­¢æ‰‹æ©Ÿç€è¦½å™¨çš„ç¸®æ”¾ */
         input[type="text"], 
         input[type="email"], 
         input[type="password"], 
         input[type="number"], 
         input[type="tel"], 
         input[type="url"], 
         select, 
         textarea {
             font-size: 16px !important;
         }
         
         /* ç™»å…¥å€åŸŸæ¨£å¼ */
         .login-section {
             background: linear-gradient(145deg, #f8f9fa, #e9ecef);
             padding: 16px;
             border-radius: 12px;
             margin-bottom: 12px;
             border: 1px solid rgba(102, 126, 234, 0.1);
             box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
             text-align: center;
         }
         
         .login-section h3 {
             margin: 0 0 12px 0;
             color: #2c3e50;
             font-size: 16px;
             font-weight: 600;
         }
         
         .user-info {
             background: linear-gradient(135deg, #28a745, #20c997);
             color: white;
             padding: 8px 12px;
             border-radius: 8px;
             margin-bottom: 8px;
             font-size: 14px;
             font-weight: 600;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
    </style>
</head>
<body>
        <div class="container">
                  <h1>ç•™å®ˆã€å¾Œç®¡è¡Œç¨‹ç®¡åˆ¶ç³»çµ±</h1>
                  
                  <!-- ä½¿ç”¨è€…ç™»å…¥å€åŸŸ -->
                  <div id="loginSection" class="login-section">
                      <h3>è«‹é¸æ“‡æ‚¨çš„æš±ç¨±</h3>
                      <div style="display: flex; gap: 8px; align-items: center;">
                          <select id="userNickname" style="flex: 1; min-width: 0;">
                              <option value="">è«‹é¸æ“‡æš±ç¨±</option>
                              <optgroup label="å¾Œç®¡ç§‘">
                                  <option value="ä½•ç®é¨">ä½•ç®é¨</option>
                                  <option value="å³å­Ÿè‡»">å³å­Ÿè‡»</option>
                                  <option value="å¾ä¸€å¹³">å¾ä¸€å¹³</option>
                                  <option value="é‚±åƒå®œ">é‚±åƒå®œ</option>
                                  <option value="ä¸˜ç¼ç¶¾">ä¸˜ç¼ç¶¾</option>
                                  <option value="æ»•æ„›æ–‡">æ»•æ„›æ–‡</option>
                              </optgroup>
                              <optgroup label="ç•™å®ˆç§‘">
                                  <option value="è³ˆéˆºæ°‘">è³ˆéˆºæ°‘</option>
                                  <option value="ä½•ç¾è²">ä½•ç¾è²</option>
                              </optgroup>
                          </select>
                          <button class="btn" onclick="login()" style="width: auto; min-width: 80px;">ç™»å…¥</button>
                      </div>
                      <div style="font-size: 12px; color: #666; margin-top: 4px;">
                          ğŸ’¡ æš±ç¨±ç”¨æ–¼è­˜åˆ¥è¡Œç¨‹çš„æ–°å¢è€…
                      </div>
                  </div>
                  
                  <!-- ä¸»è¦åŠŸèƒ½å€åŸŸ -->
                  <div id="mainSection" style="display: none;">
                      
                      <!-- ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º -->
                      <div id="userInfo" class="user-info" style="display: none;">
                          <span>ğŸ‘¤ ç•¶å‰ä½¿ç”¨è€…ï¼š<span id="currentUser"></span></span>
                          <button class="btn btn-small" onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); font-size: 12px; padding: 4px 8px; min-height: 28px;">ç™»å‡º</button>
                      </div>
        
        <div class="form-section">
                         <div class="form-row">
                 <label>æ—¥æœŸé¸æ“‡ï¼š</label>
                 <div class="selection-section">
                     <h3>é»æ“Šä¸‹æ–¹æ—¥æ›†é¸æ“‡æ—¥æœŸ</h3>
                     <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                         <div class="date-picker" id="mainDatePicker" onclick="toggleCalendar('main')" style="flex: 1;">
                             <div class="date-text" id="mainDateText">é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡</div>
                             <div class="date-hint">æ”¯æ´å¤šé¸æ—¥æœŸ</div>
                         </div>
                         <button class="btn btn-small" onclick="clearSelectedDates()" style="background: #6c757d; font-size: 14px; padding: 6px 8px; min-height: 36px; width: auto;">
                             æ¸…ç©ºé¸æ“‡
                         </button>
                     </div>
                     <div class="instructions">
                         <div>â€¢ é»æ“Šæ—¥æœŸé¸å–/å–æ¶ˆé¸å–</div>
                         <div>â€¢ æ‹–æ‹½é¸æ“‡æ—¥æœŸç¯„åœ</div>
                     </div>
                 </div>
             </div>
            
            <div class="form-row">
                <label>é¸æ“‡äººå“¡ï¼š</label>
                <select id="staffSelect">
                    <option value="">è«‹é¸æ“‡äººå“¡</option>
                    <optgroup label="å¾Œç®¡ç§‘">
                        <option value="å¾Œç®¡ç§‘,ä½•ç®é¨">ä½•ç®é¨</option>
                        <option value="å¾Œç®¡ç§‘,å³å­Ÿè‡»">å³å­Ÿè‡»</option>
                        <option value="å¾Œç®¡ç§‘,å¾ä¸€å¹³">å¾ä¸€å¹³</option>
                        <option value="å¾Œç®¡ç§‘,é‚±åƒå®œ">é‚±åƒå®œ</option>
                        <option value="å¾Œç®¡ç§‘,ä¸˜ç¼ç¶¾">ä¸˜ç¼ç¶¾</option>
                        <option value="å¾Œç®¡ç§‘,æ»•æ„›æ–‡">æ»•æ„›æ–‡</option>
                    </optgroup>
                    <optgroup label="ç•™å®ˆç§‘">
                        <option value="ç•™å®ˆç§‘,è³ˆéˆºæ°‘">è³ˆéˆºæ°‘</option>
                        <option value="ç•™å®ˆç§‘,ä½•ç¾è²">ä½•ç¾è²</option>
                    </optgroup>
                </select>
            </div>
            
                         <div class="form-row">
                 <label>è¡Œç¨‹ç‹€æ…‹ï¼š</label>
                 <div style="display: flex; gap: 8px; align-items: center;">
                                           <select id="statusSelect" style="flex: 1; min-width: 0;">
                          <option value="">è«‹é¸æ“‡ç‹€æ…‹</option>
                          <option value="ä¸Šç­">ä¸Šç­</option>
                          <option value="ä¼‘å‡">ä¼‘å‡</option>
                          <option value="ä¸Šåˆä¼‘å‡">ä¸Šåˆä¼‘å‡</option>
                          <option value="ä¸‹åˆä¼‘å‡">ä¸‹åˆä¼‘å‡</option>
                          <option value="å·®å‹¤">å·®å‹¤</option>
                          <option value="æœå‹™å°">æœå‹™å°</option>
                          <option value="custom">è‡ªè¡Œè¼¸å…¥...</option>
                      </select>
                                           <input type="text" id="statusInput" placeholder="è‡ªè¡Œè¼¸å…¥ç‹€æ…‹" style="flex: 1; min-width: 0; display: none;">
                      <button type="button" id="backToSelectBtn" onclick="backToStatusSelect()" style="display: none; background: #6c757d; color: white; border: none; border-radius: 4px; padding: 6px 8px; font-size: 12px; cursor: pointer; margin-left: 4px;">å›åˆ°é¸å–®</button>
                     <button class="btn" onclick="addSchedule()" style="width: auto; min-width: 80px;">æ–°å¢</button>
                     <button class="btn btn-danger" onclick="clearAll()" style="width: auto; min-width: 60px;">æ¸…é™¤</button>
                 </div>
             </div>
        </div>

                                                                       <div class="schedule-display">
               <div class="view-controls">
                   <label>æª¢è¦–æ—¥æœŸï¼š</label>
                   <div style="display: flex; gap: 8px; align-items: center; position: relative;">
                       <div class="date-picker" id="viewDatePicker" onclick="toggleCalendar('view')" style="flex: 1; position: relative; z-index: 5;">
                           <div class="date-text" id="viewDateText">é¸æ“‡æª¢è¦–æ—¥æœŸ</div>
                           <div class="date-hint">é»æ“Šé¸æ“‡</div>
                       </div>
                       <button class="btn btn-small" onclick="copyScheduleText()" style="background: #17a2b8; font-size: 10px; padding: 6px 8px; min-height: 36px; width: auto; position: relative; z-index: 1;">
                           è¤‡è£½
                       </button>
                   </div>
               </div>
              
                                                                                                                                               <!-- Google Sheets åŒæ­¥æç¤º -->
                   <div id="githubSyncStatus" style="margin-top: 8px; padding: 8px; border-radius: 8px;">
                       <div style="font-size: 12px; text-align: center;">
                           <span id="syncStatusText">â˜ï¸ D1 è³‡æ–™åº«å·²å•Ÿç”¨ - æ‰€æœ‰è£ç½®è³‡æ–™å³æ™‚åŒæ­¥</span>
                       </div>
                   </div>
             <div id="scheduleOutput">
                 <div class="no-data">è«‹é¸æ“‡æ—¥æœŸæª¢è¦–è¡Œç¨‹</div>
             </div>
         </div>

                 <!-- æ—¥æ›†å½ˆå‡ºè¦–çª— -->
         <div id="calendarPopup" class="calendar-popup" style="display: none;" onclick="event.stopPropagation();">
             <div class="calendar-header">
                 <button class="calendar-nav" onclick="previousMonth()">â€¹</button>
                 <div class="calendar-title" id="calendarTitle"></div>
                 <button class="calendar-nav" onclick="nextMonth()">â€º</button>
             </div>
             <div class="calendar-grid" id="calendarGrid"></div>
             <div class="calendar-footer">
                 <button class="btn btn-small" onclick="selectToday()">ä»Šå¤©</button>
                 <button class="btn btn-small" onclick="closeCalendar()">é—œé–‰</button>
             </div>
         </div>
    </div>

    <script>
                 // åˆå§‹åŒ–
         let schedules = {};
         let currentCalendarType = null; // 'main', 'view'
         let currentCalendarDate = new Date();
         let selectedDates = []; // å­˜å„²é¸ä¸­çš„æ—¥æœŸ
         let isDragging = false;
         let dragStartDate = null;
         let dragEndDate = null;
         let touchStartTime = 0;
         let currentUser = ''; // ç•¶å‰ä½¿ç”¨è€…æš±ç¨±
         
                           // ç³»çµ±é…ç½®
        const SYSTEM_NAME = 'ç•™å®ˆã€å¾Œç®¡è¡Œç¨‹ç®¡åˆ¶ç³»çµ±';
        
        // D1 è³‡æ–™åº« API ç«¯é»
        const API_BASE_URL = window.location.origin;
        const SCHEDULES_API = `${API_BASE_URL}/api/schedules`;
        const USERS_API = `${API_BASE_URL}/api/users`;
        const DEPARTMENTS_API = `${API_BASE_URL}/api/departments`;
          
          // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
          checkLoginStatus();
          
          // æª¢æŸ¥è‡ªå‹•åŒæ­¥ç‹€æ…‹ä¸¦æ›´æ–°é¡¯ç¤º
          updateAutoSyncStatus();
          
          // å¾ D1 è³‡æ–™åº«è¼‰å…¥è³‡æ–™
          loadSchedulesFromDB();
          
          // èª¿è©¦ï¼šæª¢æŸ¥è¼‰å…¥çš„è³‡æ–™
          console.log('è¼‰å…¥çš„è¡Œç¨‹è³‡æ–™:', schedules);
        
        // è¨­å®šä»Šå¤©æ—¥æœŸç‚ºé è¨­å€¼
        setDateDisplay('viewDateText', getTodayDate());
        
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWeekday(dateStr) {
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const date = new Date(dateStr);
            return weekdays[date.getDay()];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = getWeekday(dateStr);
            return `${month}/${day}ï¼ˆ${weekday}ï¼‰`;
        }

        function setDateDisplay(elementId, dateStr) {
            const element = document.getElementById(elementId);
            if (dateStr) {
                const date = new Date(dateStr);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = getWeekday(dateStr);
                element.textContent = `${month}/${day}ï¼ˆ${weekday}ï¼‰`;
                element.parentElement.classList.add('selected');
            } else {
                let defaultText = 'é¸æ“‡æ—¥æœŸ';
                if (elementId.includes('view')) defaultText = 'é¸æ“‡æª¢è¦–æ—¥æœŸ';
                else if (elementId.includes('main')) defaultText = 'é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡';
                element.textContent = defaultText;
                element.parentElement.classList.remove('selected');
            }
        }

        function updateMainDateDisplay() {
            const element = document.getElementById('mainDateText');
            if (selectedDates.length === 0) {
                element.textContent = 'é»æ“Šé–‹å•Ÿæ—¥æ›†é¸æ“‡';
                element.parentElement.classList.remove('selected');
            } else if (selectedDates.length === 1) {
                const date = new Date(selectedDates[0]);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = getWeekday(selectedDates[0]);
                element.textContent = `${month}/${day}ï¼ˆ${weekday}ï¼‰`;
                element.parentElement.classList.add('selected');
            } else {
                element.textContent = `å·²é¸æ“‡ ${selectedDates.length} å€‹æ—¥æœŸ`;
                element.parentElement.classList.add('selected');
            }
        }

        function getSelectedDateValue(type) {
            if (type === 'view') {
                const elementId = type + 'DateText';
                const element = document.getElementById(elementId);
                const text = element.textContent;
                if (text.includes('é¸æ“‡')) return '';
                
                // å¾é¡¯ç¤ºæ–‡å­—ä¸­æå–æ—¥æœŸ
                const match = text.match(/(\d+)\/(\d+)/);
                if (match) {
                    const month = parseInt(match[1]);
                    const day = parseInt(match[2]);
                    
                    // æ™ºèƒ½åˆ¤æ–·å¹´ä»½ï¼šå¦‚æœæœˆä»½æ˜¯12æœˆä¸”ç•¶å‰æ˜¯1æœˆï¼Œå‰‡ä½¿ç”¨å»å¹´
                    // å¦‚æœæœˆä»½æ˜¯1æœˆä¸”ç•¶å‰æ˜¯12æœˆï¼Œå‰‡ä½¿ç”¨æ˜å¹´
                    let year = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    if (month === 12 && currentMonth === 1) {
                        year = year - 1; // å»å¹´12æœˆ
                    } else if (month === 1 && currentMonth === 12) {
                        year = year + 1; // æ˜å¹´1æœˆ
                    }
                    
                    return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                }
                return '';
            }
            return '';
        }

                 function toggleCalendar(type) {
             currentCalendarType = type;
             const popup = document.getElementById('calendarPopup');
             
             if (popup.style.display === 'none') {
                 // é¡¯ç¤ºæ—¥æ›†
                 currentCalendarDate = new Date();
                 renderCalendar();
                 popup.style.display = 'block';
                 
                 // é˜²æ­¢äº‹ä»¶å†’æ³¡
                 event.stopPropagation();
             } else {
                 popup.style.display = 'none';
             }
         }

        function renderCalendar() {
            const title = document.getElementById('calendarTitle');
            const grid = document.getElementById('calendarGrid');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            title.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // æ¸…ç©ºç¶²æ ¼
            grid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-weekday';
                dayElement.textContent = day;
                grid.appendChild(dayElement);
            });
            
            // ç²å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ç”Ÿæˆæ—¥æœŸç¶²æ ¼
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºé¸ä¸­çš„æ—¥æœŸ
                const dateStr = date.getFullYear() + '-' + 
                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(date.getDate()).padStart(2, '0');
                
                if (selectedDates.includes(dateStr)) {
                    dayElement.classList.add('multi-selected');
                }
                
                dayElement.textContent = date.getDate();
                
                // æ·»åŠ äº‹ä»¶ç›£è½å™¨
                dayElement.addEventListener('click', (e) => handleDateClick(date, e));
                dayElement.addEventListener('mousedown', (e) => handleDateMouseDown(date, e));
                dayElement.addEventListener('mouseover', (e) => handleDateMouseOver(date, e));
                dayElement.addEventListener('touchstart', (e) => handleDateTouchStart(date, e), { passive: false });
                dayElement.addEventListener('touchmove', (e) => handleDateTouchMove(date, e), { passive: false });
                dayElement.addEventListener('touchend', (e) => handleDateTouchEnd(date, e));
                
                grid.appendChild(dayElement);
            }
        }

        function handleDateClick(date, event) {
            // é˜²æ­¢è§¸æ§äº‹ä»¶å¹²æ“¾
            if (event.type === 'touchstart' || event.type === 'touchmove' || event.type === 'touchend') {
                return;
            }
            
            if (currentCalendarType === 'view') {
                const dateStr = date.getFullYear() + '-' + 
                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(date.getDate()).padStart(2, '0');
                setDateDisplay('viewDateText', dateStr);
                closeCalendar();
                displaySchedule(dateStr);
                return;
            }
            
            if (currentCalendarType === 'main') {
                // å¦‚æœæ˜¯æ‹–æ‹½æ“ä½œï¼Œä¸è™•ç†é»æ“Š
                if (isDragging) {
                    return;
                }
                
                const dateStr = date.getFullYear() + '-' + 
                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(date.getDate()).padStart(2, '0');
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“é¸ä¸­é€™å€‹æ—¥æœŸ
                if (selectedDates.includes(dateStr)) {
                    // å¦‚æœå·²ç¶“é¸ä¸­ï¼Œå‰‡å–æ¶ˆé¸å–
                    selectedDates = selectedDates.filter(d => d !== dateStr);
                } else {
                    // æª¢æŸ¥æ˜¯å¦è¶…éæœ€å¤§é¸æ“‡æ•¸é‡
                    if (selectedDates.length >= 31) {
                        alert('æœ€å¤šåªèƒ½é¸æ“‡31å€‹æ—¥æœŸ');
                        return;
                    }
                    // å¦‚æœæ²’æœ‰é¸ä¸­ï¼Œå‰‡æ·»åŠ åˆ°é¸ä¸­åˆ—è¡¨
                    selectedDates.push(dateStr);
                }
                
                updateMainDateDisplay();
                renderCalendar();
            }
        }

        function handleDateMouseDown(date, event) {
            isDragging = false;
            const dateStr = date.getFullYear() + '-' + 
                String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(date.getDate()).padStart(2, '0');
            dragStartDate = dateStr;
            dragEndDate = dateStr;
        }

        function handleDateMouseOver(date, event) {
            if (dragStartDate) {
                if (!isDragging) {
                    isDragging = true;
                }
                const dateStr = date.getFullYear() + '-' + 
                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(date.getDate()).padStart(2, '0');
                dragEndDate = dateStr;
                renderCalendar();
            }
        }

        function handleDateTouchStart(date, event) {
            // åªåœ¨å¿…è¦æ™‚é˜»æ­¢é è¨­è¡Œç‚º
            touchStartTime = Date.now();
            isDragging = false;
            const dateStr = date.getFullYear() + '-' + 
                String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(date.getDate()).padStart(2, '0');
            dragStartDate = dateStr;
            dragEndDate = dateStr;
        }

        function handleDateTouchMove(date, event) {
            if (dragStartDate) {
                // åªåœ¨æ‹–æ‹½æ™‚é˜»æ­¢é è¨­è¡Œç‚º
                if (!isDragging) {
                    isDragging = true;
                }
                const dateStr = date.getFullYear() + '-' + 
                    String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(date.getDate()).padStart(2, '0');
                dragEndDate = dateStr;
                renderCalendar();
            }
        }

        function handleDateTouchEnd(date, event) {
            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartTime;
            
            if (currentCalendarType === 'view') {
                // æª¢è¦–æ—¥æ›†çš„è§¸æ§è™•ç†
                if (touchDuration < 400 && !isDragging) {
                    const dateStr = date.getFullYear() + '-' + 
                        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(date.getDate()).padStart(2, '0');
                    setDateDisplay('viewDateText', dateStr);
                    closeCalendar();
                    displaySchedule(dateStr);
                    return;
                }
            }
            
            if (currentCalendarType === 'main') {
                // å¦‚æœè§¸æ§æ™‚é–“å¾ˆçŸ­ä¸”æ²’æœ‰æ‹–æ‹½ï¼Œå‰‡è¦–ç‚ºé»æ“Š
                if (touchDuration < 400 && !isDragging) {
                    const dateStr = date.getFullYear() + '-' + 
                        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(date.getDate()).padStart(2, '0');
                    
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“é¸ä¸­é€™å€‹æ—¥æœŸ
                    if (selectedDates.includes(dateStr)) {
                        // å¦‚æœå·²ç¶“é¸ä¸­ï¼Œå‰‡å–æ¶ˆé¸å–
                        selectedDates = selectedDates.filter(d => d !== dateStr);
                    } else {
                        // æª¢æŸ¥æ˜¯å¦è¶…éæœ€å¤§é¸æ“‡æ•¸é‡
                        if (selectedDates.length >= 31) {
                            alert('æœ€å¤šåªèƒ½é¸æ“‡31å€‹æ—¥æœŸ');
                            return;
                        }
                        // å¦‚æœæ²’æœ‰é¸ä¸­ï¼Œå‰‡æ·»åŠ åˆ°é¸ä¸­åˆ—è¡¨
                        selectedDates.push(dateStr);
                    }
                    
                    updateMainDateDisplay();
                    renderCalendar();
                }
                
                // æ‹–æ‹½çµæŸè™•ç†ç”± handleDragEnd çµ±ä¸€è™•ç†
            }
        }

        function selectDate(date) {
            const dateStr = date.getFullYear() + '-' + 
                String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(date.getDate()).padStart(2, '0');
            
            if (currentCalendarType === 'view') {
                setDateDisplay('viewDateText', dateStr);
            }
            
            closeCalendar();
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function selectToday() {
            const today = new Date();
            selectDate(today);
        }

        function closeCalendar() {
            document.getElementById('calendarPopup').style.display = 'none';
        }

        function addSchedule() {
            const staffValue = document.getElementById('staffSelect').value;
            const statusSelect = document.getElementById('statusSelect');
            const statusInput = document.getElementById('statusInput');
            
            // ç²å–ç‹€æ…‹å€¼
            let status = '';
            let isCustomInput = false;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªè¡Œè¼¸å…¥æ¨¡å¼
            if (statusSelect.style.display === 'none' || statusInput.style.display === 'block') {
                isCustomInput = true;
                status = statusInput.value.trim();
            } else {
                status = statusSelect.value;
            }

                         if (selectedDates.length === 0) {
                 alert('è«‹å…ˆé¸æ“‡è¦æ–°å¢è¡Œç¨‹çš„æ—¥æœŸ');
                 return;
             }
 
             if (!staffValue) {
                 alert('è«‹é¸æ“‡è¦æ–°å¢è¡Œç¨‹çš„äººå“¡');
                 return;
             }
            
            if (!status) {
                if (isCustomInput) {
                    alert('è«‹è¼¸å…¥è¡Œç¨‹ç‹€æ…‹');
                } else {
                    alert('è«‹é¸æ“‡è¡Œç¨‹ç‹€æ…‹');
                }
                return;
            }
            
            // é©—è­‰æ—¥æœŸæ ¼å¼
            const invalidDates = selectedDates.filter(date => {
                const dateObj = new Date(date);
                return isNaN(dateObj.getTime());
            });
            
            if (invalidDates.length > 0) {
                alert('ç™¼ç¾ç„¡æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œè«‹é‡æ–°é¸æ“‡');
                selectedDates.length = 0;
                updateMainDateDisplay();
                renderCalendar();
                return;
            }

            const [department, staffName] = staffValue.split(',');

            // ç‚ºæ¯å€‹é¸ä¸­çš„æ—¥æœŸæ·»åŠ è¡Œç¨‹
            selectedDates.forEach(date => {
                if (!schedules[date]) {
                    schedules[date] = {};
                }

                if (!schedules[date][department]) {
                    schedules[date][department] = {};
                }

                                 schedules[date][department][staffName] = {
                     status: status,
                     addedBy: currentUser,
                     addedAt: new Date().toISOString()
                 };
            });

                         // å„²å­˜åˆ° D1 è³‡æ–™åº«
            saveSchedulesToDB(selectedDates, staffValue, status).then(({ success, errors }) => {
                console.log('è¡Œç¨‹å·²å„²å­˜åˆ°è³‡æ–™åº«');
                
                // æ›´æ–°æ‰€æœ‰æ–°å¢æ—¥æœŸçš„é¡¯ç¤º
                selectedDates.forEach(date => {
                    displaySchedule(date);
                });
                
                // å¦‚æœç•¶å‰æª¢è¦–çš„æ—¥æœŸä¸åœ¨æ–°å¢åˆ—è¡¨ä¸­ï¼Œä¹Ÿè¦æ›´æ–°ç•¶å‰æª¢è¦–
                const currentViewDate = getSelectedDateValue('view');
                if (currentViewDate && !selectedDates.includes(currentViewDate)) {
                    displaySchedule(currentViewDate);
                }
                
                // é‡ç½®è¡¨å–®
                document.getElementById('staffSelect').value = '';
                
                // é‡ç½®ç‹€æ…‹é¸æ“‡
                if (isCustomInput) {
                    // å¦‚æœä¹‹å‰æ˜¯è‡ªè¡Œè¼¸å…¥æ¨¡å¼ï¼Œæ¸…ç©ºè¼¸å…¥æ¡†ä½†ä¿æŒè‡ªå®šç¾©æ¨¡å¼
                    statusInput.value = '';
                    // ä¿æŒè‡ªå®šç¾©æ¨¡å¼æ¨™è¨˜ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒè¼¸å…¥
                    // ç¢ºä¿è¼¸å…¥æ¡†ä»ç„¶é¡¯ç¤º
                    statusInput.style.display = 'block';
                    document.getElementById('backToSelectBtn').style.display = 'block';
                } else {
                    // å¦‚æœä¹‹å‰æ˜¯é¸å–®æ¨¡å¼ï¼Œé‡ç½®ç‚ºç©ºå€¼
                    statusSelect.value = '';
                }
                
                // æ¸…ç©ºé¸ä¸­çš„æ—¥æœŸ
                selectedDates.length = 0;
                updateMainDateDisplay();
                renderCalendar();
                
                // æ ¹æ“šçµæœé¡¯ç¤ºç›¸æ‡‰è¨Šæ¯
                if (errors.length === 0) {
                    alert(`å·²æˆåŠŸæ–°å¢ ${success.length} å€‹æ—¥æœŸçš„è¡Œç¨‹`);
                } else {
                    const successCount = success.length;
                    const errorCount = errors.length;
                    alert(`éƒ¨åˆ†æˆåŠŸï¼š${successCount} å€‹æ—¥æœŸæˆåŠŸï¼Œ${errorCount} å€‹æ—¥æœŸå¤±æ•—\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦å¤±æ•—çš„æ—¥æœŸ`);
                }
            }).catch(error => {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        }

        function displaySchedule(dateStr = null) {
            const date = dateStr || getSelectedDateValue('view');
            const output = document.getElementById('scheduleOutput');

            if (!date || !schedules[date]) {
                output.innerHTML = '<div class="no-data">æ­¤æ—¥æœŸæ²’æœ‰è¡Œç¨‹è³‡æ–™</div>';
                return;
            }

            let html = `<div class="date-header">${formatDate(date)}</div>`;

            // æŒ‰éƒ¨é–€é †åºé¡¯ç¤º
            const departmentOrder = ['å¾Œç®¡ç§‘', 'ç•™å®ˆç§‘'];
            
            departmentOrder.forEach(dept => {
                if (schedules[date][dept] && Object.keys(schedules[date][dept]).length > 0) {
                    html += `<div class="department">`;
                    html += `<div class="department-name">ï¼»${dept}ï¼½</div>`;
                    html += `<div class="staff-list">`;
                    
                                         Object.entries(schedules[date][dept]).forEach(([name, data]) => {
                         // æ”¯æ´èˆŠæ ¼å¼å’Œæ–°æ ¼å¼
                         const status = typeof data === 'string' ? data : data.status;
                         const addedBy = typeof data === 'string' ? 'æœªçŸ¥' : (data.addedBy || 'æœªçŸ¥');
                         
                         html += `<div class="staff-item">`;
                         html += `<div class="staff-info">`;
                         html += `<span class="staff-name">${name}ï¼š</span>`;
                         html += `<span class="staff-status">${status}</span>`;
                         html += `<span style="font-size: 11px; color: #666; margin-left: 8px;">(ç”± ${addedBy} æ–°å¢)</span>`;
                         html += `</div>`;
                         html += `<button class="btn-delete" onclick="deleteStaffSchedule('${date}', '${dept}', '${name}')" title="åˆªé™¤æ­¤è¡Œç¨‹"></button>`;
                         html += `</div>`;
                     });
                    
                    html += `</div></div>`;
                }
            });

            output.innerHTML = html;
        }

        function clearSelectedDates() {
            selectedDates.length = 0;
            updateMainDateDisplay();
            renderCalendar();
        }

        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                schedules = {};
                // æ³¨æ„ï¼šé€™è£¡éœ€è¦å¯¦ä½œæ¸…é™¤æ‰€æœ‰è³‡æ–™çš„ API
                alert('æ¸…é™¤åŠŸèƒ½éœ€è¦å¯¦ä½œ D1 è³‡æ–™åº«çš„æ¸…é™¤ API');
                displaySchedule();
            }
        }
         
                   function copyScheduleText() {
              const output = document.getElementById('scheduleOutput');
              
                             // æª¢æŸ¥æ˜¯å¦æœ‰è¡Œç¨‹è³‡æ–™
               if (!output.querySelector('.date-header')) {
                   alert('è«‹å…ˆé¸æ“‡æ—¥æœŸæª¢è¦–è¡Œç¨‹ï¼Œæ‰èƒ½è¤‡è£½è³‡æ–™');
                   return;
               }
              
              // ç›´æ¥å¾DOMçµæ§‹ç”Ÿæˆæ–‡å­—ï¼Œé¿å…innerTextçš„å•é¡Œ
              let formattedText = '';
              
              // ç²å–æ—¥æœŸæ¨™é¡Œ
              const dateHeader = output.querySelector('.date-header');
              if (dateHeader) {
                  formattedText += dateHeader.textContent + '\n\n';
              }
              
              // ç²å–éƒ¨é–€è³‡è¨Š
              const departments = output.querySelectorAll('.department');
              departments.forEach(dept => {
                  const deptName = dept.querySelector('.department-name');
                  if (deptName) {
                      formattedText += deptName.textContent + '\n';
                  }
                  
                  const staffItems = dept.querySelectorAll('.staff-item');
                                     staffItems.forEach(staff => {
                       const staffName = staff.querySelector('.staff-name');
                       const staffStatus = staff.querySelector('.staff-status');
                       if (staffName && staffStatus) {
                           const nameText = staffName.textContent;
                           const statusText = staffStatus.textContent;
                           formattedText += '  ' + nameText + statusText + '\n';
                       }
                   });
                  
                  formattedText += '\n';
              });
              
              // æ¸…ç†å¤šé¤˜çš„ç©ºè¡Œ
              formattedText = formattedText.replace(/\n\s*\n\s*\n/g, '\n\n').trim();
              
              // ä½¿ç”¨ç¾ä»£ç€è¦½å™¨çš„ Clipboard API
              if (navigator.clipboard && window.isSecureContext) {
                  navigator.clipboard.writeText(formattedText).then(() => {
                      alert('è¡Œç¨‹æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                  }).catch(() => {
                      // å¦‚æœ Clipboard API å¤±æ•—ï¼Œä½¿ç”¨å‚³çµ±æ–¹æ³•
                      fallbackCopyTextToClipboard(formattedText);
                  });
              } else {
                  // å‚³çµ±æ–¹æ³•
                  fallbackCopyTextToClipboard(formattedText);
              }
          }
         
         function fallbackCopyTextToClipboard(text) {
             const textArea = document.createElement('textarea');
             textArea.value = text;
             textArea.style.position = 'fixed';
             textArea.style.left = '-999999px';
             textArea.style.top = '-999999px';
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             
             try {
                 document.execCommand('copy');
                 alert('è¡Œç¨‹æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
             } catch (err) {
                 alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡æ–‡å­—è¤‡è£½');
             }
             
             document.body.removeChild(textArea);
         }
        


        // æ·»åŠ æ»‘é¼ å’Œè§¸æ§äº‹ä»¶è™•ç†
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('touchend', handleDragEnd);
        
        function handleDragEnd() {
            if (isDragging && dragStartDate && dragEndDate) {
                // åªæœ‰åœ¨çœŸæ­£æ‹–æ‹½æ™‚æ‰è™•ç†ç¯„åœé¸æ“‡
                const start = new Date(dragStartDate);
                const end = new Date(dragEndDate);
                
                if (start > end) {
                    [start, end] = [end, start];
                }
                
                const rangeDates = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.getFullYear() + '-' + 
                        String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(d.getDate()).padStart(2, '0');
                    rangeDates.push(dateStr);
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ—¥æœŸç¯„åœï¼ˆé¿å…é¸æ“‡éå¤šæ—¥æœŸï¼‰
                if (rangeDates.length > 31) {
                    alert('æ‹–æ‹½ç¯„åœéå¤§ï¼Œæœ€å¤šåªèƒ½é¸æ“‡31å¤©');
                    // é‡ç½®æ‹–æ‹½ç‹€æ…‹
                    isDragging = false;
                    dragStartDate = null;
                    dragEndDate = null;
                    return;
                }
                
                // å°‡æ‹–æ‹½ç¯„åœçš„æ—¥æœŸæ·»åŠ åˆ°é¸ä¸­åˆ—è¡¨ï¼ˆå»é‡ï¼‰
                rangeDates.forEach(dateStr => {
                    if (!selectedDates.includes(dateStr)) {
                        selectedDates.push(dateStr);
                    }
                });
                
                updateMainDateDisplay();
                renderCalendar();
            }
            
            // é‡ç½®æ‹–æ‹½ç‹€æ…‹
            isDragging = false;
            dragStartDate = null;
            dragEndDate = null;
        }

                 // é»æ“Šå¤–éƒ¨é—œé–‰æ—¥æ›†
         document.addEventListener('click', function(event) {
             const popup = document.getElementById('calendarPopup');
             const isClickInside = popup.contains(event.target);
             const isClickOnPicker = event.target.closest('.date-picker');
             const isClickOnButton = event.target.closest('button');
             
             // åªæœ‰åœ¨é»æ“Šå¤–éƒ¨ä¸”ä¸æ˜¯æŒ‰éˆ•æ™‚æ‰é—œé–‰æ—¥æ›†
             if (!isClickInside && !isClickOnPicker && !isClickOnButton && popup.style.display === 'block') {
                 closeCalendar();
             }
         });

                                                                       
            
                         
            
        // D1 è³‡æ–™åº«ç›¸é—œå‡½æ•¸
        async function saveSchedulesToDB(selectedDates, staffValue, status) {
            try {
                console.log('é–‹å§‹å„²å­˜åˆ° D1 è³‡æ–™åº«...');
                
                const results = [];
                const errors = [];
                
                // ç‚ºæ¯å€‹é¸ä¸­çš„æ—¥æœŸæ·»åŠ è¡Œç¨‹
                for (const date of selectedDates) {
                    try {
                        const [department, staffName] = staffValue.split(',');
                        
                        const response = await fetch(SCHEDULES_API, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                date,
                                department,
                                staff_name: staffName,
                                status,
                                added_by: currentUser
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`å„²å­˜å¤±æ•—: ${response.status}`);
                        }
                        
                        results.push(date);
                        console.log(`æ—¥æœŸ ${date} å„²å­˜æˆåŠŸ`);
                    } catch (error) {
                        console.error(`æ—¥æœŸ ${date} å„²å­˜å¤±æ•—:`, error);
                        errors.push({ date, error: error.message });
                    }
                }
                
                // å¦‚æœæœ‰éŒ¯èª¤ï¼Œé¡¯ç¤ºéƒ¨åˆ†æˆåŠŸçš„è¨Šæ¯
                if (errors.length > 0) {
                    const successCount = results.length;
                    const errorCount = errors.length;
                    console.warn(`${successCount} å€‹æ—¥æœŸæˆåŠŸï¼Œ${errorCount} å€‹æ—¥æœŸå¤±æ•—`);
                    
                    if (successCount > 0) {
                        console.log('æˆåŠŸå„²å­˜çš„æ—¥æœŸ:', results);
                    }
                    if (errorCount > 0) {
                        console.error('å¤±æ•—çš„æ—¥æœŸ:', errors);
                    }
                } else {
                    console.log('æ‰€æœ‰æ—¥æœŸéƒ½å·²æˆåŠŸå„²å­˜åˆ° D1 è³‡æ–™åº«');
                }
                
                return { success: results, errors };
            } catch (error) {
                console.error('D1 è³‡æ–™åº«å„²å­˜éŒ¯èª¤:', error);
                throw error;
            }
        }
        
        async function loadSchedulesFromDB() {
            try {
                console.log('å˜—è©¦è¼‰å…¥ D1 è³‡æ–™åº«...');
                const response = await fetch(SCHEDULES_API);
                console.log('API å›æ‡‰ç‹€æ…‹:', response.status);
                console.log('API å›æ‡‰æ¨™é ­:', response.headers);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    console.log('å›æ‡‰å…§å®¹é¡å‹:', contentType);
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        schedules = data;
                        console.log('å¾ D1 è³‡æ–™åº«è¼‰å…¥è³‡æ–™æˆåŠŸ');
                        return true;
                    } else {
                        const text = await response.text();
                        console.error('API è¿”å›é JSON è³‡æ–™:', text.substring(0, 200));
                        throw new Error('API è¿”å›é JSON è³‡æ–™');
                    }
                } else {
                    console.log('D1 è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œç‹€æ…‹ç¢¼:', response.status);
                    const errorText = await response.text();
                    console.error('éŒ¯èª¤è©³æƒ…:', errorText.substring(0, 200));
                    schedules = {};
                    return false;
                }
            } catch (error) {
                console.error('å¾ D1 è³‡æ–™åº«è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                console.log('ä½¿ç”¨æœ¬åœ°å„²å­˜ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ');
                loadSchedulesFromStorage();
                return false;
            }
        }
        
        async function deleteScheduleFromDB(date, department, staff_name) {
            try {
                const response = await fetch(SCHEDULES_API, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date,
                        department,
                        staff_name,
                        added_by: currentUser
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`åˆªé™¤å¤±æ•—: ${response.status}`);
                }
                
                console.log('è¡Œç¨‹å·²å¾ D1 è³‡æ–™åº«åˆªé™¤');
                return true;
            } catch (error) {
                console.error('D1 è³‡æ–™åº«åˆªé™¤éŒ¯èª¤:', error);
                throw error;
            }
        }
        

            
            
            
                         // è¼”åŠ©å‡½æ•¸ï¼šå°‡é¡¯ç¤ºæ ¼å¼çš„æ—¥æœŸè½‰æ›ç‚ºæ¨™æº–æ ¼å¼
             function parseDateFromDisplay(dateStr) {
                 // è™•ç† "æœˆ/æ—¥ï¼ˆæ˜ŸæœŸï¼‰" æ ¼å¼
                 const match = dateStr.match(/(\d+)\/(\d+)/);
                 if (match) {
                     const month = parseInt(match[1]);
                     const day = parseInt(match[2]);
                     const year = new Date().getFullYear();
                     return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                 }
                 return null;
             }
             
             
          
          // æœ¬åœ°å„²å­˜ç›¸é—œå‡½æ•¸ï¼ˆå‚™ç”¨ï¼‰
          function saveSchedulesToStorage() {
              try {
                  localStorage.setItem('personnelSchedules', JSON.stringify(schedules));
              } catch (error) {
                  console.error('å„²å­˜è³‡æ–™å¤±æ•—:', error);
              }
          }
          
          function loadSchedulesFromStorage() {
              try {
                  const savedData = localStorage.getItem('personnelSchedules');
                  if (savedData) {
                      schedules = JSON.parse(savedData);
                  }
              } catch (error) {
                  console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                  schedules = {};
              }
          }
        
        // è¡Œç¨‹ç‹€æ…‹é¸å–®è™•ç†
        document.getElementById('statusSelect').addEventListener('change', function() {
            const statusSelect = document.getElementById('statusSelect');
            const statusInput = document.getElementById('statusInput');
            const backToSelectBtn = document.getElementById('backToSelectBtn');
            
            if (statusSelect.value === 'custom') {
                // é¡¯ç¤ºè‡ªè¡Œè¼¸å…¥æ¡†å’Œå›åˆ°é¸å–®æŒ‰éˆ•
                statusSelect.style.display = 'none';
                statusInput.style.display = 'block';
                backToSelectBtn.style.display = 'block';
                statusInput.focus();
                statusInput.value = '';
                
                // æ¨™è¨˜ç‚ºæ­£åœ¨è¼¸å…¥æ¨¡å¼
                statusInput.dataset.isCustomMode = 'true';
                
                // åœ¨æ‰‹æ©Ÿä¸Šï¼Œå»¶é²èšç„¦ä»¥é¿å…è§¸æ§äº‹ä»¶è¡çª
                setTimeout(() => {
                    statusInput.focus();
                }, 1000);
            }
        });
        
        // è‡ªè¡Œè¼¸å…¥æ¡†å¤±å»ç„¦é»æ™‚çš„è™•ç† - è€ƒæ…®è§¸æ§ç‹€æ…‹
        document.getElementById('statusInput').addEventListener('blur', function(event) {
            // å¦‚æœæ­£åœ¨è§¸æ§ï¼Œä¸è™•ç†bluräº‹ä»¶
            if (isTouching) {
                return;
            }
            
            // åœ¨æ‰‹æ©Ÿä¸Šï¼Œbluräº‹ä»¶å¯èƒ½æœƒå› ç‚ºè§¸æ§æ“ä½œè€Œè§¸ç™¼
            // æˆ‘å€‘éœ€è¦å»¶é²æª¢æŸ¥ï¼Œé¿å…èˆ‡è§¸æ§äº‹ä»¶è¡çª
            setTimeout(() => {
                const statusInput = document.getElementById('statusInput');
                const statusSelect = document.getElementById('statusSelect');
                const backToSelectBtn = document.getElementById('backToSelectBtn');
                
                // å¦‚æœæ­£åœ¨è§¸æ§ï¼Œä¸è™•ç†
                if (isTouching) {
                    return;
                }
                
                // åªæœ‰åœ¨è¼¸å…¥æ¡†ç‚ºç©ºä¸”ç¢ºå¯¦è™•æ–¼è‡ªå®šç¾©æ¨¡å¼æ™‚æ‰è·³å›é¸å–®
                if (statusInput.value.trim() === '' && statusInput.dataset.isCustomMode === 'true') {
                    // æª¢æŸ¥æ˜¯å¦çœŸçš„å¤±å»äº†ç„¦é»ï¼ˆä¸æ˜¯å› ç‚ºé»æ“Šå…¶ä»–å…ƒç´ ï¼‰
                    if (document.activeElement !== statusInput) {
                        statusSelect.style.display = 'block';
                        statusInput.style.display = 'none';
                        backToSelectBtn.style.display = 'none';
                        statusSelect.value = '';
                        delete statusInput.dataset.isCustomMode;
                    }
                }
            }, 2000); // å»¶é²200msï¼Œé¿å…èˆ‡è§¸æ§äº‹ä»¶è¡çª
        });
        
        // è‡ªè¡Œè¼¸å…¥æ¡†æŒ‰ä¸‹Enteréµæ™‚çš„è™•ç†
        document.getElementById('statusInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const statusInput = document.getElementById('statusInput');
                
                // å¦‚æœæœ‰è¼¸å…¥å…§å®¹ï¼Œä¿æŒè‡ªå®šç¾©æ¨¡å¼
                if (statusInput.value.trim() !== '') {
                    return;
                }
                
                // å¦‚æœæ²’æœ‰è¼¸å…¥å…§å®¹ï¼Œå›åˆ°é¸å–®
                backToStatusSelect();
            }
        });
        
        // æ·»åŠ è§¸æ§äº‹ä»¶è™•ç†ï¼Œé˜²æ­¢æ‰‹æ©Ÿä¸Šçš„æ„å¤–è·³å›
        let isTouching = false;
        
        document.getElementById('statusInput').addEventListener('touchstart', function() {
            isTouching = true;
        });
        
        document.getElementById('statusInput').addEventListener('touchend', function() {
            setTimeout(() => {
                isTouching = false;
            }, 100);
        });
        
        // å›åˆ°ç‹€æ…‹é¸å–®çš„å‡½æ•¸
        function backToStatusSelect() {
            const statusSelect = document.getElementById('statusSelect');
            const statusInput = document.getElementById('statusInput');
            const backToSelectBtn = document.getElementById('backToSelectBtn');
            
            statusSelect.style.display = 'block';
            statusInput.style.display = 'none';
            backToSelectBtn.style.display = 'none';
            statusSelect.value = ''; // é‡ç½®ç‚ºç©ºå€¼
            delete statusInput.dataset.isCustomMode;
        }
        
        // æª¢æŸ¥ç•¶å‰ç‹€æ…‹é¸æ“‡æ¨¡å¼çš„å‡½æ•¸
        function getCurrentStatusMode() {
            const statusSelect = document.getElementById('statusSelect');
            const statusInput = document.getElementById('statusInput');
            
            if (statusSelect.style.display === 'none' || statusInput.style.display === 'block') {
                return 'custom';
            } else {
                return 'select';
            }
        }
        
                 // åˆªé™¤ç‰¹å®šäººå“¡çš„è¡Œç¨‹
         function deleteStaffSchedule(date, department, staffName) {
             // æª¢æŸ¥æ¬Šé™ï¼šåªæœ‰æ–°å¢è€…æˆ–ç®¡ç†å“¡å¯ä»¥åˆªé™¤
             const scheduleData = schedules[date]?.[department]?.[staffName];
             if (scheduleData) {
                 const addedBy = typeof scheduleData === 'string' ? 'æœªçŸ¥' : (scheduleData.addedBy || 'æœªçŸ¥');
                 if (addedBy !== 'æœªçŸ¥' && addedBy !== currentUser) {
                     alert(`åªæœ‰è¡Œç¨‹æ–°å¢è€… (${addedBy}) æ‰èƒ½åˆªé™¤æ­¤è¡Œç¨‹`);
                     return;
                 }
             }
             
             if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${staffName} åœ¨ ${formatDate(date)} çš„è¡Œç¨‹å—ï¼Ÿ`)) {
                 // åˆªé™¤è©²äººå“¡çš„è¡Œç¨‹
                 if (schedules[date] && schedules[date][department]) {
                     delete schedules[date][department][staffName];
                     
                     // å¦‚æœè©²éƒ¨é–€æ²’æœ‰äººå“¡äº†ï¼Œåˆªé™¤æ•´å€‹éƒ¨é–€
                     if (Object.keys(schedules[date][department]).length === 0) {
                         delete schedules[date][department];
                     }
                     
                     // å¦‚æœè©²æ—¥æœŸæ²’æœ‰éƒ¨é–€äº†ï¼Œåˆªé™¤æ•´å€‹æ—¥æœŸ
                     if (Object.keys(schedules[date]).length === 0) {
                         delete schedules[date];
                     }
                     
                     // å„²å­˜åˆ° D1 è³‡æ–™åº«
                     deleteScheduleFromDB(date, department, staffName).then(() => {
                         console.log('è¡Œç¨‹å·²å¾è³‡æ–™åº«åˆªé™¤');
                         // å³æ™‚æ›´æ–°æª¢è¦–
                         displaySchedule(date);
                     }).catch(error => {
                         console.error('åˆªé™¤å¤±æ•—:', error);
                         alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                     });
                     
                     alert(`å·²åˆªé™¤ ${staffName} çš„è¡Œç¨‹`);
                 }
             }
         }

                            // ç™»å…¥åŠŸèƒ½
         function login() {
             const nickname = document.getElementById('userNickname').value;
             if (!nickname) {
                 alert('è«‹é¸æ“‡æš±ç¨±');
                 return;
             }
             
             currentUser = nickname;
             localStorage.setItem('userNickname', nickname);
             
             // éš±è—ç™»å…¥å€åŸŸï¼Œé¡¯ç¤ºä¸»è¦åŠŸèƒ½
             document.getElementById('loginSection').style.display = 'none';
             document.getElementById('mainSection').style.display = 'block';
             
             // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
             document.getElementById('currentUser').textContent = nickname;
             document.getElementById('userInfo').style.display = 'flex';
             
             // é‡ç½®é¸å–®
             document.getElementById('userNickname').value = '';
         }
         
         // ç™»å‡ºåŠŸèƒ½
         function logout() {
             currentUser = '';
             localStorage.removeItem('userNickname');
             
             // éš±è—ä¸»è¦åŠŸèƒ½ï¼Œé¡¯ç¤ºç™»å…¥å€åŸŸ
             document.getElementById('mainSection').style.display = 'none';
             document.getElementById('loginSection').style.display = 'block';
             document.getElementById('userInfo').style.display = 'none';
         }
         
         // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
         function checkLoginStatus() {
             const savedNickname = localStorage.getItem('userNickname');
             if (savedNickname) {
                 currentUser = savedNickname;
                 
                 // éš±è—ç™»å…¥å€åŸŸï¼Œé¡¯ç¤ºä¸»è¦åŠŸèƒ½
                 document.getElementById('loginSection').style.display = 'none';
                 document.getElementById('mainSection').style.display = 'block';
                 
                 // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
                 document.getElementById('currentUser').textContent = savedNickname;
                 document.getElementById('userInfo').style.display = 'flex';
             } else {
                 // é¡¯ç¤ºç™»å…¥å€åŸŸ
                 document.getElementById('loginSection').style.display = 'block';
                 document.getElementById('mainSection').style.display = 'none';
                 document.getElementById('userInfo').style.display = 'none';
             }
         }
         
        // æ›´æ–° D1 è³‡æ–™åº«åŒæ­¥ç‹€æ…‹é¡¯ç¤º
        function updateAutoSyncStatus() {
            const statusDiv = document.getElementById('githubSyncStatus');
            const statusText = document.getElementById('syncStatusText');
            
            // é¡¯ç¤º D1 è³‡æ–™åº«åŒæ­¥ç‹€æ…‹
            statusDiv.style.background = 'rgba(40, 167, 69, 0.1)';
            statusDiv.style.border = '1px solid #28a745';
            statusText.style.color = '#28a745';
            statusText.textContent = 'ğŸ—„ï¸ D1 è³‡æ–™åº«å·²å•Ÿç”¨ - æ‰€æœ‰è£ç½®è³‡æ–™å³æ™‚åŒæ­¥';
        }
         
         // åˆå§‹åŒ–
         updateMainDateDisplay();
         
         // æ·»åŠ è‡ªå‹•åŒæ­¥
         window.addEventListener('load', async function() {
             console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è‡ªå‹•åŒæ­¥...');
             await loadSchedulesFromDB();
             displaySchedule();
         });
         
         // æ¯30ç§’è‡ªå‹•æª¢æŸ¥æ›´æ–°
         setInterval(async function() {
             console.log('æª¢æŸ¥ D1 è³‡æ–™åº«æ›´æ–°...');
             try {
                 const response = await fetch(SCHEDULES_API);
                 if (response.ok) {
                     const dbData = await response.json();
                     if (JSON.stringify(dbData) !== JSON.stringify(schedules)) {
                         console.log('ç™¼ç¾è³‡æ–™åº«æœ‰æ–°è³‡æ–™ï¼Œé–‹å§‹åŒæ­¥...');
                         schedules = dbData;
                         displaySchedule();
                     }
                 }
             } catch (error) {
                 console.log('æª¢æŸ¥æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
             }
         }, 30 * 1000);
          
          
    </script>
</body>
</html>
